<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - D'PAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-amber-50 to-orange-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h1 class="text-3xl font-bold text-amber-900 mb-2 text-center">Panel Admin</h1>
            <p class="text-center text-gray-600 mb-6">D'PAN - Panader√≠a Artesanal</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                    <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                </div>
                <button type="submit" class="w-full bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition font-semibold">
                    Iniciar Sesi√≥n
                </button>
                <p id="login-error" class="text-red-500 text-sm hidden text-center"></p>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-amber-700 to-amber-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Panel de Administraci√≥n</h1>
                    <p class="text-amber-100 text-sm">D'PAN - Panader√≠a Artesanal</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="admin-username" class="text-amber-100"></span>
                    <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700 transition font-semibold">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- PRODUCTOS SECTION -->
            <div class="mb-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Productos</h2>
                    <button onclick="openProductModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition flex items-center font-semibold">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Nuevo Producto
                    </button>
                </div>
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- CUPONES SECTION -->
            <div class="border-t-2 border-gray-200 pt-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Cupones</h2>
                    <button onclick="openCouponModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition flex items-center font-semibold">
                        <i data-lucide="ticket" class="w-5 h-5 mr-2"></i>
                        Nuevo Cup√≥n
                    </button>
                </div>
                <div id="coupons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>

    <!-- Modal Productos -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Nuevo Producto</h3>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre del Producto *</label>
                    <input type="text" id="product-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Precio ($) *</label>
                        <input type="number" id="product-price" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Descuento (%) üî•</label>
                        <input type="number" id="product-discount" min="0" max="100" step="1" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descripci√≥n Corta *</label>
                    <textarea id="product-short-desc" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descripci√≥n Completa *</label>
                    <textarea id="product-long-desc" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Ingredientes (uno por l√≠nea) *</label>
                    <textarea id="product-ingredients" rows="4" placeholder="Harina&#10;Agua&#10;Sal&#10;Levadura" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="font-semibold text-blue-900 mb-3">üéØ Puntajes del Quiz (nuevo sistema):</p>
                    <div class="space-y-2 text-sm text-blue-800">
                        <label class="flex items-center">
                            <input type="radio" name="quiz-category" value="3,4" class="mr-2"> <strong>3,4</strong> ‚Üí Dulces (panecitos, tortas, budines)
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="quiz-category" value="6,7" class="mr-2"> <strong>6,7</strong> ‚Üí Vers√°tiles (chip√°, bizcochos, pan)
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="quiz-category" value="8,9" class="mr-2"> <strong>8,9</strong> ‚Üí Salados (pan lactal, pizzetas, s√°ndwiches)
                        </label>
                    </div>
                    <input type="hidden" id="product-quiz-score">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="product-featured" class="mr-2 w-4 h-4">
                    <label class="text-sm font-semibold text-gray-700">‚≠ê Producto Destacado</label>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Imagen del Producto</label>
                    <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <div id="current-image-preview" class="mt-2 hidden">
                        <img id="current-image" src="" class="w-32 h-32 object-cover rounded border">
                    </div>
                </div>

                <div class="flex space-x-4 pt-4 border-t">
                    <button type="submit" class="flex-1 bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition font-semibold">
                        Guardar Producto
                    </button>
                    <button type="button" onclick="closeProductModal()" class="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cupones -->
    <div id="coupon-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 id="coupon-modal-title" class="text-2xl font-bold text-gray-800">Nuevo Cup√≥n</h3>
                <button onclick="closeCouponModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="coupon-form" class="space-y-4">
                <input type="hidden" id="coupon-id">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">C√≥digo del Cup√≥n *</label>
                    <input type="text" id="coupon-code" placeholder="VERANO2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg uppercase focus:ring-2 focus:ring-amber-500" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Descuento *</label>
                    <select id="coupon-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                        <option value="percentage">Porcentaje (%)</option>
                        <option value="fixed">Monto Fijo ($)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Monto del Descuento *</label>
                    <input type="number" id="coupon-discount" step="0.01" min="0" placeholder="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="coupon-active" checked class="mr-2 w-4 h-4">
                    <label class="text-sm font-semibold text-gray-700">Cup√≥n Activo</label>
                </div>

                <div class="flex space-x-4 pt-4 border-t">
                    <button type="submit" class="flex-1 bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition font-semibold">
                        Guardar Cup√≥n
                    </button>
                    <button type="button" onclick="closeCouponModal()" class="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editingProductId = null;
        let editingCouponId = null;

        // Crear iconos cuando lucide est√© listo
        window.addEventListener('load', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        // Check Auth
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/check');
                if (!res.ok) throw new Error('Not authenticated');
                const data = await res.json();
                if (data.authenticated) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('admin-username').textContent = data.username;
                    loadProducts();
                    loadCoupons();
                }
            } catch {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) checkAuth();
                else {
                    errorEl.textContent = data.error || 'Error al iniciar sesi√≥n';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                errorEl.textContent = 'Error de conexi√≥n';
                errorEl.classList.remove('hidden');
            }
        });

        // Logout
        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            checkAuth();
        }

        // === PRODUCTOS ===
        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                const grid = document.getElementById('products-grid');
                grid.innerHTML = products.map(p => {
                    const hasDiscount = p.discount && p.discount > 0;
                    const discountedPrice = hasDiscount ? Math.round(p.price * (1 - p.discount / 100)) : p.price;
                    const priceHTML = hasDiscount 
                        ? `<div class="text-sm text-gray-400 line-through">$${p.price}</div><div class="text-xl font-bold text-red-600">$${discountedPrice}</div>`
                        : `<div class="text-xl font-bold text-amber-600">$${p.price}</div>`;
                    return `
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 ${hasDiscount ? 'border-red-500' : 'border-amber-400'}">
                            <img src="${p.img_url}" alt="${p.name}" class="w-full h-40 object-cover rounded mb-3">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${p.name}</h3>
                            <p class="text-xs text-gray-600 mb-2">${p.short_description}</p>
                            <div class="mb-2">
                                ${priceHTML}
                                ${hasDiscount ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">-${p.discount}%</span>` : ''}
                            </div>
                            <div class="text-xs mb-3">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Quiz: ${p.quiz_score?.join(',') || 'N/A'}</span>
                                ${p.featured ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded ml-1">Destacado</span>' : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editProduct('${p.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-700">Editar</button>
                                <button onclick="deleteProduct('${p.id}')" class="flex-1 bg-red-600 text-white py-2 rounded text-sm hover:bg-red-700">Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function openProductModal() {
            editingProductId = null;
            document.getElementById('modal-title').textContent = 'Nuevo Producto';
            document.getElementById('product-form').reset();
            document.getElementById('current-image-preview').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        }

        async function editProduct(id) {
            try {
                const res = await fetch(`/api/products/${id}`);
                const p = await res.json();
                editingProductId = id;
                document.getElementById('modal-title').textContent = 'Editar Producto';
                document.getElementById('product-id').value = p.id;
                document.getElementById('product-name').value = p.name;
                document.getElementById('product-price').value = p.price;
                document.getElementById('product-discount').value = p.discount || 0;
                document.getElementById('product-short-desc').value = p.short_description;
                document.getElementById('product-long-desc').value = p.long_description;
                document.getElementById('product-ingredients').value = p.ingredients.join('\n');
                document.getElementById('product-featured').checked = p.featured;
                document.querySelector(`input[name="quiz-category"][value="${p.quiz_score.join(',')}"]`).checked = true;
                if (p.img_url) {
                    document.getElementById('current-image').src = p.img_url;
                    document.getElementById('current-image-preview').classList.remove('hidden');
                }
                document.getElementById('product-modal').classList.remove('hidden');
            } catch (error) {
                alert('Error al cargar el producto');
            }
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const quizValue = document.querySelector('input[name="quiz-category"]:checked')?.value;
            if (!quizValue) {
                alert('Selecciona una categor√≠a de quiz');
                return;
            }
            const formData = new FormData();
            const id = editingProductId || `product-${Date.now()}`;
            formData.append('id', id);
            formData.append('name', document.getElementById('product-name').value);
            formData.append('short_description', document.getElementById('product-short-desc').value);
            formData.append('long_description', document.getElementById('product-long-desc').value);
            formData.append('ingredients', JSON.stringify(document.getElementById('product-ingredients').value.split('\n').filter(i => i.trim())));
            formData.append('price', document.getElementById('product-price').value);
            formData.append('discount', document.getElementById('product-discount').value || 0);
            formData.append('featured', document.getElementById('product-featured').checked);
            formData.append('quiz_score', JSON.stringify(quizValue.split(',').map(Number)));
            const imageFile = document.getElementById('product-image').files[0];
            if (imageFile) formData.append('image', imageFile);
            try {
                const url = editingProductId ? `/api/admin/products/${editingProductId}` : '/api/admin/products';
                const res = await fetch(url, { method: editingProductId ? 'PUT' : 'POST', body: formData });
                if (res.ok) {
                    closeProductModal();
                    loadProducts();
                    alert('Producto guardado');
                }
            } catch (error) {
                alert('Error al guardar');
            }
        });

        async function deleteProduct(id) {
            if (!confirm('¬øEliminar este producto?')) return;
            try {
                const res = await fetch(`/api/admin/products/${id}`, { method: 'DELETE' });
                if (res.ok) loadProducts();
            } catch (error) {
                alert('Error al eliminar');
            }
        }

        // === CUPONES ===
        async function loadCoupons() {
            try {
                const res = await fetch('/api/admin/coupons');
                const coupons = await res.json();
                const grid = document.getElementById('coupons-grid');
                grid.innerHTML = coupons.map(c => `
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 ${c.active ? 'border-green-500' : 'border-gray-300'} ${!c.active ? 'opacity-60' : ''}">
                        <h3 class="font-bold text-2xl text-gray-800 mb-1">${c.code}</h3>
                        <p class="text-sm text-gray-600 mb-3">${c.type === 'percentage' ? c.discount + '%' : '$' + c.discount}</p>
                        <span class="text-xs px-2 py-1 rounded ${c.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${c.active ? 'Activo' : 'Inactivo'}
                        </span>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="editCoupon('${c.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-700">Editar</button>
                            <button onclick="deleteCoupon('${c.id}')" class="flex-1 bg-red-600 text-white py-2 rounded text-sm hover:bg-red-700">Eliminar</button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading coupons:', error);
            }
        }

        function openCouponModal() {
            editingCouponId = null;
            document.getElementById('coupon-modal-title').textContent = 'Nuevo Cup√≥n';
            document.getElementById('coupon-form').reset();
            document.getElementById('coupon-active').checked = true;
            document.getElementById('coupon-modal').classList.remove('hidden');
        }

        async function editCoupon(id) {
            try {
                const res = await fetch('/api/admin/coupons');
                const coupons = await res.json();
                const c = coupons.find(x => x.id === id);
                if (!c) return;
                editingCouponId = id;
                document.getElementById('coupon-modal-title').textContent = 'Editar Cup√≥n';
                document.getElementById('coupon-code').value = c.code;
                document.getElementById('coupon-type').value = c.type;
                document.getElementById('coupon-discount').value = c.discount;
                document.getElementById('coupon-active').checked = c.active;
                document.getElementById('coupon-modal').classList.remove('hidden');
            } catch (error) {
                alert('Error al cargar el cup√≥n');
            }
        }

        function closeCouponModal() {
            document.getElementById('coupon-modal').classList.add('hidden');
        }

        document.getElementById('coupon-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                code: document.getElementById('coupon-code').value.toUpperCase(),
                type: document.getElementById('coupon-type').value,
                discount: document.getElementById('coupon-discount').value,
                active: document.getElementById('coupon-active').checked
            };
            try {
                const url = editingCouponId ? `/api/admin/coupons/${editingCouponId}` : '/api/admin/coupons';
                const res = await fetch(url, {
                    method: editingCouponId ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeCouponModal();
                    loadCoupons();
                    alert('Cup√≥n guardado');
                }
            } catch (error) {
                alert('Error al guardar');
            }
        });

        async function deleteCoupon(id) {
            if (!confirm('¬øEliminar este cup√≥n?')) return;
            try {
                const res = await fetch(`/api/admin/coupons/${id}`, { method: 'DELETE' });
                if (res.ok) loadCoupons();
            } catch (error) {
                alert('Error al eliminar');
            }
        }

        checkAuth();
    </script>
</body>
</html>
