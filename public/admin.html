<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Admin Panel - D'PAN</title>
ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <script src="https://unpkg.com/lucide@latest"></script>
ย ย <script>
ย ย ย ย tailwind.config = {
ย ย ย ย ย ย theme: {
ย ย ย ย ย ย ย ย extend: {
ย ย ย ย ย ย ย ย ย ย colors: {
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-dark': '#8B5E3C',ย ย ย
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-light': '#F5E3C0',ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-cream': '#FFF4E1',ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-accent': '#D19C4C',ย ย
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-orange': '#E28C42',ย ย
ย ย ย ย ย ย ย ย ย ย ย ย 'pan-contrast': '#5C3A21',ย
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย </script>
</head>
<body class="bg-gray-100 min-h-screen">
ย ย ย ย <div id="login-screen" class="flex items-center justify-center min-h-screen">
ย ย ย ย <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
ย ย ย ย ย ย <h1 class="text-3xl font-bold text-pan-dark mb-6 text-center">Panel Admin D'PAN</h1>
ย ย ย ย ย ย <form id="login-form" class="space-y-4">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="login-username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pan-orange" required>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Contraseรฑa</label>
ย ย ย ย ย ย ย ย ย ย <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pan-orange" required>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button type="submit" class="w-full bg-pan-orange text-white py-2 rounded-lg hover:bg-pan-dark transition">
ย ย ย ย ย ย ย ย ย ย Iniciar Sesiรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <p id="login-error" class="text-red-500 text-sm hidden"></p>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>

ย ย ย ย <div id="admin-panel" class="hidden">
ย ย ย ย <header class="bg-pan-dark text-white shadow-lg">
ย ย ย ย ย ย <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
ย ย ย ย ย ย ย ย <h1 class="text-2xl font-bold">Panel de Administraciรณn - D'PAN</h1>
ย ย ย ย ย ย ย ย <div class="flex items-center space-x-4">
ย ย ย ย ย ย ย ย ย ย <span id="admin-username" class="text-pan-light"></span>
ย ย ย ย ย ย ย ย ย ย <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">
ย ย ย ย ย ย ย ย ย ย ย ย Cerrar Sesiรณn
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </header>

ย ย ย ย ย ย ย ย <main class="max-w-7xl mx-auto px-4 py-8">
ย ย ย ย ย ย <div class="mb-6 flex justify-between items-center">
ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-pan-dark">Gestiรณn de Productos</h2>
ย ย ย ย ย ย ย ย <button onclick="openProductModal()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition flex items-center">
ย ย ย ย ย ย ย ย ย ย <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
ย ย ย ย ย ย ย ย ย ย Nuevo Producto
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
ย ย ย ย </main>

ย ย ย ย ย ย ย ย <section class="max-w-7xl mx-auto px-4 py-8 mt-8 border-t-4 border-pan-orange">
ย ย ย ย ย ย <div class="mb-6 flex justify-between items-center">
ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-pan-dark">Gestiรณn de Cupones</h2>
ย ย ย ย ย ย ย ย <button onclick="openCouponModal()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition flex items-center">
ย ย ย ย ย ย ย ย ย ย <i data-lucide="ticket" class="w-5 h-5 mr-2"></i>
ย ย ย ย ย ย ย ย ย ย Nuevo Cupรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="coupons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
ย ย ย ย </section>
ย ย </div>
ย ย ย ย <div id="product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
ย ย ย ย <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
ย ย ย ย ย ย <div class="flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย <h3 id="modal-title" class="text-2xl font-bold text-pan-dark">Nuevo Producto</h3>
ย ย ย ย ย ย ย ย <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700">
ย ย ย ย ย ย ย ย ย ย <i data-lucide="x" class="w-6 h-6"></i>
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <form id="product-form" class="space-y-4">
ย ย ย ย ย ย ย ย <input type="hidden" id="product-id">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto *</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="product-name" class="w-full px-4 py-2 border rounded-lg" required>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Descripciรณn Corta *</label>
ย ย ย ย ย ย ย ย ย ย <textarea id="product-short-desc" rows="2" class="w-full px-4 py-2 border rounded-lg" required></textarea>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Descripciรณn Completa *</label>
ย ย ย ย ย ย ย ย ย ย <textarea id="product-long-desc" rows="4" class="w-full px-4 py-2 border rounded-lg" required></textarea>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Ingredientes (uno por lรญnea) *</label>
ย ย ย ย ย ย ย ย ย ย <textarea id="product-ingredients" rows="4" class="w-full px-4 py-2 border rounded-lg" placeholder="Harina&#10;Agua&#10;Sal" required></textarea>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 gap-4">
ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Precio ($) *</label>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="product-price" step="0.01" class="w-full px-4 py-2 border rounded-lg" required>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Descuento (%) ๐ฅ</label>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="product-discount" min="0" max="100" step="1" placeholder="0" class="w-full px-4 py-2 border rounded-lg border-red-300 focus:ring-red-500">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-gray-500 mt-1">0 = sin oferta, 20 = 20% OFF</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="flex items-center space-x-6">
ย ย ย ย ย ย ย ย ย ย <label class="flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="checkbox" id="product-featured" class="mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-sm font-medium text-gray-700">โญ Producto Destacado</span>
ย ย ย ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Etiquetas (Tags) de Producto *</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="product-tags" placeholder="Ej: dulce, salado, merienda, cena" class="w-full px-4 py-2 border rounded-lg" required>
ย ย ย ย ย ย ย ย ย ย <div class="mt-2 p-3 bg-green-50 rounded text-xs">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="font-semibold mb-1">๐ก Consejos:</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p>โข Use palabras clave separadas por comas (ej: **dulce**, **salado**, **merienda**).</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p>โข Estas etiquetas definen quรฉ productos recomendarรก el Quiz.</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Imagen del Producto</label>
ย ย ย ย ย ย ย ย ย ย <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
ย ย ย ย ย ย ย ย ย ย <div id="current-image-preview" class="mt-2 hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600 mb-1">Imagen actual:</p>
ย ย ย ย ย ย ย ย ย ย ย ย <img id="current-image" src="" class="w-32 h-32 object-cover rounded border">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="flex space-x-4 pt-4">
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="flex-1 bg-pan-orange text-white py-2 rounded-lg hover:bg-pan-dark transition">
ย ย ย ย ย ย ย ย ย ย ย ย Guardar Producto
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button type="button" onclick="closeProductModal()" class="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">
ย ย ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>

ย ย ย ย <div id="coupon-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
ย ย ย ย <div class="bg-white rounded-xl max-w-md w-full p-6">
ย ย ย ย ย ย <div class="flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย <h3 id="coupon-modal-title" class="text-2xl font-bold text-pan-dark">Nuevo Cupรณn</h3>
ย ย ย ย ย ย ย ย <button onclick="closeCouponModal()" class="text-gray-500 hover:text-gray-700">
ย ย ย ย ย ย ย ย ย ย <i data-lucide="x" class="w-6 h-6"></i>
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <form id="coupon-form" class="space-y-4">
ย ย ย ย ย ย ย ย <input type="hidden" id="coupon-id">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Cรณdigo del Cupรณn *</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="coupon-code" placeholder="VERANO2025" class="w-full px-4 py-2 border rounded-lg uppercase" required>
ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-gray-500 mt-1">El cรณdigo se convertirรก a mayรบsculas automรกticamente</p>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Descuento *</label>
ย ย ย ย ย ย ย ย ย ย <select id="coupon-type" class="w-full px-4 py-2 border rounded-lg" required>
ย ย ย ย ย ย ย ย ย ย ย ย <option value="percentage">Porcentaje (%)</option>
ย ย ย ย ย ย ย ย ย ย ย ย <option value="fixed">Monto Fijo ($)</option>
ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Descuento *</label>
ย ย ย ย ย ย ย ย ย ย <input type="number" id="coupon-discount" step="0.01" min="0" placeholder="10" class="w-full px-4 py-2 border rounded-lg" required>
ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-gray-500 mt-1">Ejemplo: 10 = 10% o $10 segรบn el tipo</p>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="checkbox" id="coupon-active" checked class="mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-sm font-medium text-gray-700">Cupรณn Activo</span>
ย ย ย ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="flex space-x-4 pt-4">
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="flex-1 bg-pan-orange text-white py-2 rounded-lg hover:bg-pan-dark transition">
ย ย ย ย ย ย ย ย ย ย ย ย Guardar Cupรณn
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button type="button" onclick="closeCouponModal()" class="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">
ย ย ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>
ย ย <script>
ย ย ย ย lucide.createIcons();
ย ย ย ย let editingProductId = null;
ย ย ย ย let editingCouponId = null;

ย ย ย ย // Check authentication
ย ย ย ย async function checkAuth() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch('/api/auth/check');
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (data.authenticated) {
ย ย ย ย ย ย ย ย ย ย document.getElementById('login-screen').classList.add('hidden');
ย ย ย ย ย ย ย ย ย ย document.getElementById('admin-panel').classList.remove('hidden');
ย ย ย ย ย ย ย ย ย ย document.getElementById('admin-username').textContent = data.username;
ย ย ย ย ย ย ย ย ย ย loadProducts();
ย ย ย ย ย ย ย ย ย ย loadCoupons();
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย document.getElementById('login-screen').classList.remove('hidden');
ย ย ย ย ย ย ย ย ย ย document.getElementById('admin-panel').classList.add('hidden');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error checking auth:', error);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Login
ย ย ย ย document.getElementById('login-form').addEventListener('submit', async (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย const username = document.getElementById('login-username').value;
ย ย ย ย ย ย const password = document.getElementById('login-password').value;
ย ย ย ย ย ย const errorEl = document.getElementById('login-error');
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch('/api/auth/login', {
ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ username, password })
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const data = await res.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (res.ok) {
ย ย ย ย ย ย ย ย ย ย checkAuth();
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย errorEl.textContent = data.error || 'Error al iniciar sesiรณn';
ย ย ย ย ย ย ย ย ย ย errorEl.classList.remove('hidden');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย errorEl.textContent = 'Error de conexiรณn';
ย ย ย ย ย ย ย ย errorEl.classList.remove('hidden');
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // Logout
ย ย ย ย async function logout() {
ย ย ย ย ย ย await fetch('/api/auth/logout', { method: 'POST' });
ย ย ย ย ย ย checkAuth();
ย ย ย ย }

ย ย ย ย // === PRODUCTOS ===

ย ย ย ย async function loadProducts() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch('/api/products');
ย ย ย ย ย ย ย ย const products = await res.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const grid = document.getElementById('products-grid');
ย ย ย ย ย ย ย ย grid.innerHTML = products.map(p => {
ย ย ย ย ย ย ย ย ย ย const hasDiscount = p.discount && p.discount > 0;
ย ย ย ย ย ย ย ย ย ย const discountedPrice = hasDiscount ? Math.round(p.price * (1 - p.discount / 100)) : p.price;
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const priceHTML = hasDiscountย
ย ย ย ย ย ย ย ย ย ย ย ย ? `<div class="flex flex-col"><span class="text-sm text-gray-400 line-through">$${p.price}</span><span class="text-xl font-bold text-red-600">$${discountedPrice}</span></div>`
ย ย ย ย ย ย ย ย ย ย ย ย : `<span class="text-xl font-bold text-pan-orange">$${p.price}</span>`;
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const offerBadge = hasDiscountย
ย ย ย ย ย ย ย ย ย ย ย ย ? `<span class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">-${p.discount}% OFF</span>`
ย ย ย ย ย ย ย ย ย ย ย ย : '';
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-lg shadow-lg p-4 ${hasDiscount ? 'border-2 border-red-400' : ''}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${hasDiscount ? '<div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded font-bold">ยกOFERTA!</div>' : ''}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <img src="${p.img_url}" alt="${p.name}" class="w-full h-48 object-cover rounded mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-bold text-lg text-pan-dark mb-1">${p.name}</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600 mb-2">${p.short_description}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${priceHTML}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${offerBadge}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${p.featured ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded ml-2">Destacado</span>' : ''}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex space-x-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="editProduct('${p.id}')" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Editar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="deleteProduct('${p.id}')" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600 transition text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Eliminar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย }).join('');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย lucide.createIcons();
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error loading products:', error);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function openProductModal() {
ย ย ย ย ย ย editingProductId = null;
ย ย ย ย ย ย document.getElementById('modal-title').textContent = 'Nuevo Producto';
ย ย ย ย ย ย document.getElementById('product-form').reset();
ย ย ย ย ย ย document.getElementById('product-id').value = '';
ย ย ย ย ย ย document.getElementById('product-discount').value = 0;
ย ย ย ย ย ย document.getElementById('current-image-preview').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('product-modal').classList.remove('hidden');
ย ย ย ย }

ย ย ย ย async function editProduct(id) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`/api/products/${id}`);
ย ย ย ย ย ย ย ย const product = await res.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย editingProductId = id;
ย ย ย ย ย ย ย ย document.getElementById('modal-title').textContent = 'Editar Producto';
ย ย ย ย ย ย ย ย document.getElementById('product-id').value = product.id;
ย ย ย ย ย ย ย ย document.getElementById('product-name').value = product.name;
ย ย ย ย ย ย ย ย document.getElementById('product-short-desc').value = product.short_description;
ย ย ย ย ย ย ย ย document.getElementById('product-long-desc').value = product.long_description;
ย ย ย ย ย ย ย ย document.getElementById('product-ingredients').value = product.ingredients.join('\n');
ย ย ย ย ย ย ย ย document.getElementById('product-price').value = product.price;
ย ย ย ย ย ย ย ย document.getElementById('product-discount').value = product.discount || 0;
ย ย ย ย ย ย ย ย document.getElementById('product-featured').checked = product.featured;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // INICIO CAMBIO DE quiz_score A tags
ย ย ย ย ย ย ย ย // Si el producto tiene 'tags' (el nuevo campo), lo usamos. Si tiene el viejo 'quiz_score', lo usamos (para compatibilidad temporal).
ย ย ย ย ย ย ย ย // Si tenรฉs que editar un producto viejo que aรบn tiene 'quiz_score', aparecerรกn los nรบmeros en el campo de tags.
ย ย ย ย ย ย ย ย const tagsOrScores = product.tags ? product.tags.join(', ') : (product.quiz_score ? product.quiz_score.join(', ') : '');
ย ย ย ย ย ย ย ย document.getElementById('product-tags').value = tagsOrScores;
ย ย ย ย ย ย ย ย // FIN CAMBIO DE quiz_score A tags
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (product.img_url) {
ย ย ย ย ย ย ย ย ย ย document.getElementById('current-image').src = product.img_url;
ย ย ย ย ย ย ย ย ย ย document.getElementById('current-image-preview').classList.remove('hidden');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย document.getElementById('product-modal').classList.remove('hidden');
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error loading product:', error);
ย ย ย ย ย ย ย ย alert('Error al cargar el producto');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function closeProductModal() {
ย ย ย ย ย ย document.getElementById('product-modal').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('product-form').reset();
ย ย ย ย ย ย editingProductId = null;
ย ย ย ย }

ย ย ย ย document.getElementById('product-form').addEventListener('submit', async (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ยย
ย ย ย ย ย ย const formData = new FormData();
ย ย ย ย ย ย const id = editingProductId || `product-${Date.now()}`;
ย ย ย ย ย ยย
ย ย ย ย ย ย formData.append('id', id);
ย ย ย ย ย ย formData.append('name', document.getElementById('product-name').value);
ย ย ย ย ย ย formData.append('short_description', document.getElementById('product-short-desc').value);
ย ย ย ย ย ย formData.append('long_description', document.getElementById('product-long-desc').value);
ย ย ย ย ย ยย
ย ย ย ย ย ย const ingredients = document.getElementById('product-ingredients').value.split('\n').filter(i => i.trim());
ย ย ย ย ย ย formData.append('ingredients', JSON.stringify(ingredients));
ย ย ย ย ย ยย
ย ย ย ย ย ย formData.append('price', document.getElementById('product-price').value);
ย ย ย ย ย ย formData.append('discount', document.getElementById('product-discount').value || 0);
ย ย ย ย ย ย formData.append('featured', document.getElementById('product-featured').checked);
ย ย ย ย ย ยย
ย ย ย ย ย ย // INICIO: PROCESO PARA GUARDAR LAS TAGS (ETIQUETAS)
ย ย ย ย ย ย const tags = document.getElementById('product-tags').value
ย ย ย ย ย ย ย ย .split(',')
ย ย ย ย ย ย ย ย .map(s => s.trim().toLowerCase()) // Limpiamos y convertimos a minรบsculas para un uso consistente
ย ย ย ย ย ย ย ย .filter(s => s.length > 0); // Eliminamos tags vacรญas
ย ย ย ย ย ย formData.append('tags', JSON.stringify(tags));
ย ย ย ย ย ย // FIN: PROCESO PARA GUARDAR LAS TAGS (ETIQUETAS)
ย ย ย ย ย ยย
ย ย ย ย ย ย const imageFile = document.getElementById('product-image').files[0];
ย ย ย ย ย ย if (imageFile) {
ย ย ย ย ย ย ย ย formData.append('image', imageFile);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const url = editingProductIdย
ย ย ย ย ย ย ย ย ย ย ? `/api/admin/products/${editingProductId}`
ย ย ย ย ย ย ย ย ย ย : '/api/admin/products';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const method = editingProductId ? 'PUT' : 'POST';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const res = await fetch(url, {
ย ย ย ย ย ย ย ย ย ย method,
ย ย ย ย ย ย ย ย ย ย body: formData
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (res.ok) {
ย ย ย ย ย ย ย ย ย ย closeProductModal();
ย ย ย ย ย ย ย ย ย ย loadProducts();
ย ย ย ย ย ย ย ย ย ย alert(editingProductId ? 'Producto actualizado' : 'Producto creado');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย const error = await res.json();
ย ย ย ย ย ย ย ย ย ย alert('Error: ' + error.error);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error saving product:', error);
ย ย ย ย ย ย ย ย alert('Error al guardar el producto');
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย async function deleteProduct(id) {
ย ย ย ย ย ย if (!confirm('ยฟEstรกs seguro de eliminar este producto?')) return;
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`/api/admin/products/${id}`, {
ย ย ย ย ย ย ย ย ย ย method: 'DELETE'
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (res.ok) {
ย ย ย ย ย ย ย ย ย ย loadProducts();
ย ย ย ย ย ย ย ย ย ย alert('Producto eliminado');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย alert('Error al eliminar el producto');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error deleting product:', error);
ย ย ย ย ย ย ย ย alert('Error al eliminar el producto');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // === CUPONES ===

ย ย ย ย async function loadCoupons() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch('/api/admin/coupons');
ย ย ย ย ย ย ย ย const coupons = await res.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const grid = document.getElementById('coupons-grid');
ย ย ย ย ย ย ย ย grid.innerHTML = coupons.map(c => `
ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-lg shadow-lg p-4 ${!c.active ? 'opacity-60' : ''}">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-start mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-bold text-2xl text-pan-dark mb-1">${c.code}</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${c.type === 'percentage' ? c.discount + '% de descuento' : '$' + c.discount + ' de descuento'}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs px-2 py-1 rounded ${c.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${c.active ? 'Activo' : 'Inactivo'}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex space-x-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="editCoupon('${c.id}')" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Editar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="deleteCoupon('${c.id}')" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600 transition text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Eliminar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `).join('');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย lucide.createIcons();
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error loading coupons:', error);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function openCouponModal() {
ย ย ย ย ย ย editingCouponId = null;
ย ย ย ย ย ย document.getElementById('coupon-modal-title').textContent = 'Nuevo Cupรณn';
ย ย ย ย ย ย document.getElementById('coupon-form').reset();
ย ย ย ย ย ย document.getElementById('coupon-id').value = '';
ย ย ย ย ย ย document.getElementById('coupon-active').checked = true;
ย ย ย ย ย ย document.getElementById('coupon-modal').classList.remove('hidden');
ย ย ย ย }

ย ย ย ย async function editCoupon(id) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch('/api/admin/coupons');
ย ย ย ย ย ย ย ย const coupons = await res.json();
ย ย ย ย ย ย ย ย const coupon = coupons.find(c => c.id === id);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (!coupon) return;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย editingCouponId = id;
ย ย ย ย ย ย ย ย document.getElementById('coupon-modal-title').textContent = 'Editar Cupรณn';
ย ย ย ย ย ย ย ย document.getElementById('coupon-id').value = coupon.id;
ย ย ย ย ย ย ย ย document.getElementById('coupon-code').value = coupon.code;
ย ย ย ย ย ย ย ย document.getElementById('coupon-type').value = coupon.type;
ย ย ย ย ย ย ย ย document.getElementById('coupon-discount').value = coupon.discount;
ย ย ย ย ย ย ย ย document.getElementById('coupon-active').checked = coupon.active;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย document.getElementById('coupon-modal').classList.remove('hidden');
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error loading coupon:', error);
ย ย ย ย ย ย ย ย alert('Error al cargar el cupรณn');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function closeCouponModal() {
ย ย ย ย ย ย document.getElementById('coupon-modal').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('coupon-form').reset();
ย ย ย ย ย ย editingCouponId = null;
ย ย ย ย }

ย ย ย ย document.getElementById('coupon-form').addEventListener('submit', async (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ยย
ย ย ย ย ย ย const couponData = {
ย ย ย ย ย ย ย ย code: document.getElementById('coupon-code').value.toUpperCase(),
ย ย ย ย ย ย ย ย type: document.getElementById('coupon-type').value,
ย ย ย ย ย ย ย ย discount: document.getElementById('coupon-discount').value,
ย ย ย ย ย ย ย ย active: document.getElementById('coupon-active').checked
ย ย ย ย ย ย };
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const url = editingCouponIdย
ย ย ย ย ย ย ย ย ย ย ? `/api/admin/coupons/${editingCouponId}`
ย ย ย ย ย ย ย ย ย ย : '/api/admin/coupons';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const method = editingCouponId ? 'PUT' : 'POST';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const res = await fetch(url, {
ย ย ย ย ย ย ย ย ย ย method,
ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(couponData)
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (res.ok) {
ย ย ย ย ย ย ย ย ย ย closeCouponModal();
ย ย ย ย ย ย ย ย ย ย loadCoupons();
ย ย ย ย ย ย ย ย ย ย alert(editingCouponId ? 'Cupรณn actualizado' : 'Cupรณn creado');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย const error = await res.json();
ย ย ย ย ย ย ย ย ย ย alert('Error: ' + error.error);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error saving coupon:', error);
ย ย ย ย ย ย ย ย alert('Error al guardar el cupรณn');
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย async function deleteCoupon(id) {
ย ย ย ย ย ย if (!confirm('ยฟEstรกs seguro de eliminar este cupรณn?')) return;
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const res = await fetch(`/api/admin/coupons/${id}`, {
ย ย ย ย ย ย ย ย ย ย method: 'DELETE'
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (res.ok) {
ย ย ย ย ย ย ย ย ย ย loadCoupons();
ย ย ย ย ย ย ย ย ย ย alert('Cupรณn eliminado');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย alert('Error al eliminar el cupรณn');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error('Error deleting coupon:', error);
ย ย ย ย ย ย ย ย alert('Error al eliminar el cupรณn');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Initialize
ย ย ย ย checkAuth();
ย ย </script>
</body>
</html>
